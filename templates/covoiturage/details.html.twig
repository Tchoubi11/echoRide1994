{% extends 'base.html.twig' %}

{% block body %}
<div class="container mt-5">

    <h2>D√©tails du covoiturage</h2>

    {% if app.user == ride.driver %}
        <span class="badge bg-info">Vous √™tes le conducteur de ce trajet</span>
        <a href="{{ path('covoiturage_valider_passagers', {'id': ride.id}) }}" class="btn btn-outline-primary mt-3">
            ‚úÖ Valider les passagers
        </a>
    {% elseif ride.passengers.contains(app.user) %}
        <span class="badge bg-success">Vous √™tes passager sur ce trajet</span>
    {% endif %}

    <div class="card p-3 shadow-sm mt-3">
        <img src="{{ asset('uploads/images/67c88b34e4a07.jpg') }}" alt="Photo du chauffeur" class="driver-photo-icon" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
        <p><strong>Pseudo du chauffeur :</strong> {{ ride.driver.pseudo }}</p>
        <p><strong>{{ ride.driver.pseudo }}</strong> (<span class="star-rating">{{ ride.driver.rating|star_rating }}</span>)</p>
        <p><strong>Lieu de d√©part :</strong> {{ ride.lieuDepart }}</p>
        <p><strong>Lieu d'arriv√©e :</strong> {{ ride.lieuArrivee }}</p>
        <p><strong>Prix :</strong> {{ ride.prixPersonne }} Cr√©dits</p>

        <hr>
        <h5>üìÖ Horaires planifi√©s :</h5>
        <p><strong>D√©part pr√©vu :</strong> {{ ride.dateDepart|date('d/m/Y') }} √† {{ ride.heureDepart|date('H:i') }}</p>
        <p><strong>Arriv√©e pr√©vue :</strong> {{ ride.dateArrivee|date('d/m/Y') }} √† {{ ride.heureArrivee|date('H:i') }}</p>

        {% if ride.isStarted %}
            <hr>
            <h5>üïí Informations en temps r√©el :</h5>
            <p><strong>D√©part r√©el :</strong> {{ ride.startAt ? ride.startAt|date('d/m/Y H:i') : 'N/A' }}</p>
            {% if ride.isCompleted %}
                <p><strong>Arriv√©e r√©elle :</strong> {{ ride.endAt ? ride.endAt|date('d/m/Y H:i') : 'N/A' }}</p>
            {% endif %}
        {% else %}
            <p><strong>Statut :</strong> Le covoiturage n'a pas encore commenc√©.</p>
        {% endif %}

        <p><strong>Voyage √©cologique :</strong> {{ ride.isEco ? 'Oui' : 'Non' }}</p>

        <p><strong>V√©hicule :</strong></p>
        {% if driverCar %}
            <p><strong>Marque et Mod√®le :</strong> {{ driverCar.marque.libelle }} - {{ driverCar.modele }}</p>
            <p><strong>√ânergie utilis√©e :</strong> {{ driverCar.energie }}</p>
        {% else %}
            <p>Aucune voiture associ√©e √† ce conducteur.</p>
        {% endif %}

        <h3>Commentaires</h3>
        <ul>
            {% for avis in driverReviews %}
                <li><strong>{{ avis.reservation.passenger.pseudo }}</strong> :
                    {{ avis.commentaire }} - <span class="star-rating">{{ avis.note|star_rating }}</span>
                </li>
            {% endfor %}
        </ul>
        {% if driverReviews is empty %}
            <p>Aucun avis pour ce conducteur.</p>
        {% endif %}

        <p><strong>Pr√©f√©rences du conducteur :</strong></p>
        {% if driverPreferences %}
            <ul>
                <li><strong>Fumeur :</strong> {{ driverPreferences.fumeur ? 'Oui' : 'Non' }}</li>
                <li><strong>Animaux :</strong> {{ driverPreferences.animaux ? 'Oui' : 'Non' }}</li>
                <li><strong>Autres :</strong> 
                    {% if driverPreferences.autres is not empty %}
                        {{ driverPreferences.autres|join(', ') }}
                    {% else %}
                        Aucune
                    {% endif %}
                </li>
            </ul>
        {% else %}
            <p>Aucune pr√©f√©rence sp√©cifi√©e.</p>
        {% endif %}

        <hr>
        {# Bloc des pr√©f√©rences personnelles conducteur/passager int√©gr√© ici #}
        {% if app.user == ride.driver %}
            <h3>Mes pr√©f√©rences conducteur</h3>

            {% if editPrefs %}
                {{ form_start(preferenceForm) }}
                    <div class="mb-3">
                        {{ form_label(preferenceForm.fumeur) }}
                        {{ form_widget(preferenceForm.fumeur) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(preferenceForm.animaux) }}
                        {{ form_widget(preferenceForm.animaux) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(preferenceForm.autres) }}
                        {{ form_widget(preferenceForm.autres) }}
                    </div>
                    <button class="btn btn-primary">
                        {{ userPreferences.id ? 'Mettre √† jour mes pr√©f√©rences' : 'Enregistrer mes pr√©f√©rences' }}
                    </button>
                {{ form_end(preferenceForm) }}
            {% else %}
                <a href="{{ path('covoiturage_details', {'id': ride.id, 'editPrefs': 1}) }}" class="btn btn-outline-info mt-2">
                    ‚úèÔ∏è Modifier mes pr√©f√©rences de conducteur
                </a>
            {% endif %}

        {% elseif ride.passengers.contains(app.user) %}
            <h3>Mes pr√©f√©rences passager</h3>

            {% if userPreferences %}
                <ul>
                    <li><strong>Fumeur :</strong> {{ userPreferences.fumeur ? 'Oui' : 'Non' }}</li>
                    <li><strong>Animaux :</strong> {{ userPreferences.animaux ? 'Oui' : 'Non' }}</li>
                    <li><strong>Autres :</strong>
                        {% if userPreferences.autres is not empty %}
                            {{ userPreferences.autres|join(', ') }}
                        {% else %}
                            Aucune
                        {% endif %}
                    </li>
                </ul>
            {% else %}
                <p>Vous n'avez pas encore d√©fini vos pr√©f√©rences passager.</p>
            {% endif %}
        {% endif %}

    </div>

    <div class="d-flex gap-2 mt-3">
        {% if ride.isStarted %}
            <p class="text-muted mt-2">üöó Le covoiturage a d√©j√† d√©marr√©. Vous ne pouvez plus participer √† ce trajet.</p>
        {% elseif rideId is defined and rideId is not null %}
            <form method="post" action="{{ path('participer_covoiturage', {'rideId': ride.id}) }}">
                <button type="submit" class="btn btn-success">Participer</button>
            </form>
        {% else %}
            <p class="text-danger">Erreur : l'ID du covoiturage est manquant.</p>
        {% endif %}
    </div>

    {% if app.user and (ride.nbPlace <= 0 or (credits is not null and credits < ride.prixPersonne)) %}
        <p class="mt-3 text-danger">
            {% if ride.nbPlace <= 0 %}
                Plus de places disponibles.
            {% elseif credits is not null and credits < ride.prixPersonne %}
                <strong>Attention !!! Il ne vous reste plus assez de cr√©dits.</strong>
            {% endif %}
        </p>
    {% endif %}

    <div class="mt-4">
        <a href="{{ path('user_profile') }}" class="btn btn-secondary">üë§ Retour sur mon profil</a>
        <a href="{{ path('espace_utilisateur') }}" class="btn btn-secondary">‚öôÔ∏è Retour sur mon espace utilisateur</a>
    </div>
</div>
{% endblock %}
