{% extends 'base.html.twig' %}

{% block body %}
<div class="container mt-5">
    <h2>Bonjour {{ utilisateur.pseudo }}</h2>

    <h3>Je suis :</h3>
    {{ form_start(formType) }}
        {{ form_row(formType.type_utilisateur) }}
        <button class="btn btn-success">Mettre Ã  jour</button>
    {{ form_end(formType) }}

    {% if utilisateur.typeUtilisateur %}
        <p class="mt-2">Actuellement sÃ©lectionnÃ© : <strong>{{ utilisateur.typeUtilisateur|capitalize }}</strong></p>
    {% endif %}

    {% if utilisateur.typeUtilisateur in ['chauffeur', 'les_deux'] and utilisateur.voitures is empty %}
        <div class="alert alert-warning">
            ğŸš— Vous Ãªtes chauffeur, mais vous n'avez enregistrÃ© aucun vÃ©hicule.
            <br>
            <a href="#ajouter-vehicule" class="btn btn-sm btn-primary mt-2">Ajouter un vÃ©hicule</a>
        </div>
    {% endif %}

    {% if utilisateur.typeUtilisateur in ['chauffeur', 'les_deux'] %}
        <h3 id="ajouter-vehicule">Mes vÃ©hicules</h3>
        {% if form is not null %}
            {{ form_start(form) }}
                {{ form_row(form.immatriculation) }}
                {{ form_row(form.datePremiereImmatriculation) }}
                {{ form_row(form.modele) }}
                {{ form_row(form.couleur) }}
                {{ form_row(form.marque) }}
                {{ form_row(form.placesDisponibles) }}
                {{ form_row(form.energie) }}
                <button type="submit" class="btn btn-primary mt-3">Enregistrer</button>
            {{ form_end(form) }}
        {% endif %}
    {% endif %}

    {% if utilisateur.typeUtilisateur in ['passager', 'les_deux'] %}
        <h3 class="mt-4">ğŸ§¾ Mes rÃ©servations en tant que passager</h3>
        <a href="{{ path('reservations_to_validate') }}" class="btn btn-outline-primary mb-3">ğŸ“ Valider mes trajets</a>

        {% for res in reservations %}
    {% if res.covoiturage.isCompleted == false and res.covoiturage.isCancelled == false %}
        <div class="card p-3 mb-2">
            <strong>{{ res.covoiturage.lieuDepart }} â†’ {{ res.covoiturage.lieuArrivee }}</strong><br>
            ğŸ“… {{ res.covoiturage.dateDepart|date('d/m/Y H:i') }}<br>
            ğŸ’º Places rÃ©servÃ©es : {{ res.placesReservees }}<br>
            ğŸ’° PayÃ© : {{ res.montantPaye }} crÃ©dits

            {# ğŸ§¾ Bloc pour afficher lâ€™Ã©tat de validation #}
            <div class="mt-2">
                {% if res.aConfirmeParticipation %}
                    <span class="badge bg-success">âœ… ValidÃ©</span>
                {% elseif res.aParticipe %}
                    <a href="{{ path('reservation_valider', {id: res.id}) }}" class="btn btn-primary btn-sm">
                        Valider ma participation
                    </a>
                {% else %}
                    <span class="badge bg-warning text-dark">ğŸš« En attente de validation du chauffeur</span>
                {% endif %}
            </div>

            <form method="post" action="{{ path('annuler_covoiturage', { id: res.covoiturage.id }) }}"
                  onsubmit="return confirm('Annuler votre participation ?');">
                <button type="submit" class="btn btn-warning btn-sm mt-3">Annuler ma participation</button>
            </form>
        </div>
    {% endif %}
{% endfor %}

    {% endif %}

    {% if utilisateur.typeUtilisateur in ['chauffeur', 'les_deux'] %}
        <h3 class="mt-4">ğŸš— Mes trajets Ã  gÃ©rer en tant que chauffeur</h3>
        {% for trajet in covoituragesProposes %}
            {% if not trajet.isCompleted and not trajet.isCancelled %}
                <div class="card p-3 mb-3">
                    <strong>{{ trajet.lieuDepart }} â†’ {{ trajet.lieuArrivee }}</strong><br>
                    ğŸ“… {{ trajet.dateDepart|date('d/m/Y H:i') }}<br>
                    ğŸ’º Places : {{ trajet.nbPlace }} | ğŸ’° {{ trajet.prixPersonne }} crÃ©dits<br>

                    {% if not trajet.isStarted %}
                        <span class="badge bg-warning mt-2">ğŸ•’ Ã€ venir</span><br>
                        <form method="post" action="{{ path('demarrer_covoiturage', {'id': trajet.id}) }}">
                            <button class="btn btn-primary btn-sm mt-2">ğŸš€ DÃ©marrer</button>
                        </form>
                    {% else %}
                        <span class="badge bg-info mt-2">ğŸš— En cours</span><br>
                        <form method="post" action="{{ path('arriver_covoiturage', {'id': trajet.id}) }}">
                            <button class="btn btn-success btn-sm mt-2">ğŸ Terminer</button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if formCovoiturage is defined and formCovoiturage is not null %}
        <h3 class="mt-5">â• Proposer un trajet</h3>
        {{ form_start(formCovoiturage) }}
            {{ form_row(formCovoiturage.lieuDepart) }}
            {{ form_row(formCovoiturage.lieuArrivee) }}
            {{ form_row(formCovoiturage.dateDepart) }}
            {{ form_row(formCovoiturage.dateArrivee) }}
            {{ form_row(formCovoiturage.prixPersonne) }}
            {{ form_row(formCovoiturage.nbPlace) }}
            {{ form_row(formCovoiturage.voiture) }}
            {{ form_row(formCovoiturage.is_eco) }}
            <button class="btn btn-success mt-3">Proposer</button>
        {{ form_end(formCovoiturage) }}
    {% endif %}

    <a href="{{ path('user_profile') }}" class="btn btn-secondary mt-4">ğŸ‘¤ Voir mon profil</a>
</div>
{% endblock %}
